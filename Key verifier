local salt = "monkey"
local nonceFile = ".used_keys.txt"

-- ğŸ”§ Hex converter
local function toHex(str)
	return (str:gsub(".", function(c)
		return string.format("%02x", string.byte(c))
	end))
end

-- ğŸ”§ Base64 decoder
local function b64decode(data)
	local b64chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
	local lookup = {}
	for i = 1, #b64chars do lookup[b64chars:sub(i, i)] = i - 1 end
	data = data:gsub("[^" .. b64chars .. "=]", "")
	local bytes = {}

	for i = 1, #data, 4 do
		local c1 = lookup[data:sub(i, i)] or 0
		local c2 = lookup[data:sub(i + 1, i + 1)] or 0
		local c3 = lookup[data:sub(i + 2, i + 2)] or 0
		local c4 = lookup[data:sub(i + 3, i + 3)] or 0

		local b1 = c1 * 4 + math.floor(c2 / 16)
		table.insert(bytes, string.char(b1))

		if data:sub(i + 2, i + 2) ~= "" then
			local b2 = (c2 % 16) * 16 + math.floor(c3 / 4)
			table.insert(bytes, string.char(b2))
		end

		if data:sub(i + 3, i + 3) ~= "" then
			local b3 = (c3 % 4) * 64 + c4
			table.insert(bytes, string.char(b3))
		end
	end

	return table.concat(bytes)
end

-- ğŸ” HMAC wrapper
local function sha256_hmac(data, key)
	local raw = require(game:GetService("Players").LocalPlayer.PlayerGui.ScreenGui:FindFirstChild("SHA256_HMAC"))(data, key)
	return type(raw) == "string" and raw or toHex(raw)
end

-- ğŸ§¾ Nonce tracking
local function hasUsedNonce(nonce)
	if not isfile(nonceFile) then return false end
	local content = readfile(nonceFile)
	return content:find(nonce, 1, true) ~= nil
end

local function markNonceUsed(nonce)
	local existing = isfile(nonceFile) and readfile(nonceFile) or ""
	appendfile(nonceFile, nonce .. "\n")
end

-- âœ… Key validator
local function validateKey(encodedKey)
	local decoded = b64decode(encodedKey)
	local parts = string.split(decoded, "|")
	if #parts ~= 3 then
		warn("âŒ Invalid key format")
		return
	end

	local expiry = tonumber(parts[1])
	local nonce = parts[2]
	local hash = parts[3]

	if not expiry or not nonce or not hash then
		warn("âŒ Malformed key")
		return
	end

	if hasUsedNonce(nonce) then
		warn("âŒ Rejected: key already used")
		return
	end

	local raw = expiry .. "|" .. nonce
	local expected = sha256_hmac(raw, salt)

	if expected == hash then
		markNonceUsed(nonce)
		local remaining = expiry - os.time()
		local status = remaining > 0 and "âœ… Valid key" or "âš ï¸ Expired but untampered"
		print(string.format(
			"%s\nğŸ•’ Expiry: %s\nâ³ Remaining: %d seconds\nğŸ” Nonce: %s",
			status,
			os.date("%Y-%m-%d %H:%M:%S", expiry),
			remaining,
			nonce
		))
	else
		warn("âŒ Tampered or invalid key")
	end
end
