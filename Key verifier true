-- âš™ï¸ Config
local salt = "monkey"
local trackUsedKeys = true
local enforceExpiry = true
local runLoadstring = true
local blockPayloadOnExpiry = true
local storedkeys = "used_keys"
local usedKeyFile = "." .. storedkeys .. ".txt"

-- ğŸŒ Shared environment
local sharedEnv = {}
setfenv(1, setmetatable(sharedEnv, { __index = getfenv(0) }))

-- ğŸ–¥ï¸ GUI Setup
local gui = Instance.new("ScreenGui")
gui.Name = "KeyValidatorGui"
gui.ResetOnSpawn = false
gui.Parent = game:GetService("CoreGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 420, 0, 220)
frame.Position = UDim2.new(0.5, -210, 0.5, -110)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0

local inputBox = Instance.new("TextBox", frame)
inputBox.Size = UDim2.new(1, -20, 0, 40)
inputBox.Position = UDim2.new(0, 10, 0, 10)
inputBox.PlaceholderText = "Paste your key here"
inputBox.TextScaled = true
inputBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
inputBox.TextColor3 = Color3.new(1, 1, 1)

local outputLabel = Instance.new("TextLabel", frame)
outputLabel.Size = UDim2.new(1, -20, 0, 80)
outputLabel.Position = UDim2.new(0, 10, 0, 60)
outputLabel.Text = "Awaiting input..."
outputLabel.TextScaled = true
outputLabel.TextWrapped = true
outputLabel.BackgroundTransparency = 1
outputLabel.TextColor3 = Color3.new(1, 1, 1)

local validateButton = Instance.new("TextButton", frame)
validateButton.Size = UDim2.new(0.5, -15, 0, 40)
validateButton.Position = UDim2.new(0, 10, 0, 150)
validateButton.Text = "Validate Key"
validateButton.TextScaled = true
validateButton.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
validateButton.TextColor3 = Color3.new(1, 1, 1)

local closeButton = Instance.new("TextButton", frame)
closeButton.Size = UDim2.new(0.5, -15, 0, 40)
closeButton.Position = UDim2.new(0.5, 5, 0, 150)
closeButton.Text = "Close"
closeButton.TextScaled = true
closeButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeButton.TextColor3 = Color3.new(1, 1, 1)

-- ğŸ”§ Helpers
local function b64decode(data)
    local b = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'
    data = data:gsub('[^'..b..'=]', '')
    return (data:gsub('.', function(x)
        if x == '=' then return '' end
        local r,f = '',(b:find(x)-1)
        for i=6,1,-1 do r=r..(f%2^i - f%2^(i-1) > 0 and '1' or '0') end
        return r
    end):gsub('%d%d%d%d%d%d%d%d', function(x)
        return string.char(tonumber(x,2))
    end))
end

local function toHex(str)
    return (str:gsub('.', function(c)
        return string.format('%02x', string.byte(c))
    end))
end

local function sha256_hmac(data, key)
    local fake = "deadbeefcafebabe" .. tostring(#data + #key)
    return fake:rep(4):sub(1, 64)
end

local function hasUsedKey(encodedKey)
    if not trackUsedKeys then return false end
    if not isfile(usedKeyFile) then return false end
    local content = readfile(usedKeyFile)
    return content:find(encodedKey, 1, true) ~= nil
end

local function markKeyUsed(encodedKey)
    if trackUsedKeys then
        appendfile(usedKeyFile, encodedKey .. "\n")
    end
end

-- âœ… Key validator
local function validate(encoded)
    local decoded = b64decode(encoded)
    print("ğŸ” Decoded key:", decoded)

    local parts = string.split(decoded, "|")
    if #parts ~= 3 then
        print("âŒ Debug: Invalid format â€” expected 3 parts, got", #parts)
        return false, "âŒ Invalid format"
    end

    local expiry = tonumber(parts[1])
    local nonce = parts[2]
    local hash = parts[3]

    print("ğŸ§© Parsed parts:")
    print("  Expiry:", expiry)
    print("  Nonce:", nonce)
    print("  Hash:", hash)

    if not expiry or not nonce or not hash then
        print("âŒ Debug: Malformed key â€” missing expiry, nonce, or hash")
        return false, "âŒ Malformed key"
    end

    if enforceExpiry and expiry < os.time() then
        print("â³ Debug: Key expired â€” current:", os.time(), "expiry:", expiry)
        return false, "âŒ Key expired"
    end

    if hasUsedKey(encoded) then
        print("ğŸ” Debug: Key already used â€” rejecting")
        return false, "âŒ Rejected: key already used"
    end

    local raw = expiry .. "|" .. nonce
    local expected = toHex(sha256_hmac(raw, salt))

    print("ğŸ” Debug: HMAC check")
    print("  Raw string:", raw)
    print("  Expected hash:", expected)
    print("  Provided hash:", hash)

    if expected == hash then
        print("âœ… Debug: Hash match â€” key is valid")
        markKeyUsed(encoded)

        local remaining = expiry - os.time()
        local status = remaining > 0 and "âœ… Valid key" or "âš ï¸ Expired but untampered"
        local msg = string.format("%s\nğŸ•’ Expiry: %s\nâ³ Remaining: %ds\nğŸ” Nonce: %s",
            status,
            os.date("%Y-%m-%d %H:%M:%S", expiry),
            remaining,
            nonce
        )

        sharedEnv.shutdownflag = false

        if runLoadstring and (not blockPayloadOnExpiry or remaining > 0) then
            loadstring([[ -- payload block here ]])()
        end

        return true, msg
    else
        print("âŒ Debug: Hash mismatch â€” key is tampered or invalid")
        return false, "âŒ Tampered or invalid key"
    end
end
